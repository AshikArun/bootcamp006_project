---
title: "Citibike User Patterns"
author: "Will Bartlett"
date: "July 17, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("/Users/williambartlett/Downloads")
citibike_df = read.csv("201606-citibike-tripdata.csv")
library(ggplot2)
library(ggmap)
library(dplyr)
library(maps)
library(mapdata)
library(rgdal)

my_citibike_df = select(citibike_df,
                        starttime, 
                        start.station.name, 
                        start.station.latitude,
                        start.station.longitude)
my_citibike_df$starttime = as.character.Date(my_citibike_df$starttime)
my_citibike_df$starttime = strptime(my_citibike_df$starttime, "%m/%d/%Y %H:%M:%S")
my_citibike_df = my_citibike_df %>% 
      mutate(day_of_week = weekdays(my_citibike_df$starttime)) %>%
      mutate(hour = my_citibike_df$starttime$hour)
day = my_citibike_df$day_of_week
weekday_log = ifelse(day == "Monday" |
                           day == "Tuesday" |
                           day == "Wednesday" |
                           day == "Thursday" |
                           day == "Friday", T, F)
my_citibike_df = mutate(my_citibike_df, weekday_logical = weekday_log)
weekday_df = my_citibike_df[my_citibike_df$weekday_logical == T,-1]
weekend_df = my_citibike_df[my_citibike_df$weekday_logical == F,-1]

#trip starts by hour map functions
maps_total = function(x, y){
      library(ggplot2) 
      library(dplyr)
      library(maps)
      library(mapdata)
      library(rgdal)
      
      stat_lat_long = weekday_df[,c(1,2,3)]
      stat_lat_long = unique(stat_lat_long)
      
      nyc = get_map(location = "New York City", maptype = "roadmap", zoom = 12)
      nycMap = ggmap(nyc)
      weekday_df_x_y = filter(weekday_df, hour >= x & hour <= y) %>%
            group_by(start.station.name) %>%
            summarise(trips = n()) %>%
            inner_join(stat_lat_long, by = "start.station.name")
      max_station = arrange(weekday_df_x_y, desc(trips))
      print(max_station[1:5,])
      print(median(max_station$trips))
      hour_usage_map = nycMap + geom_point(data = weekday_df_x_y, 
                                           mapping = aes(x =start.station.longitude, 
                                                         y = start.station.latitude,
                                                         color = trips,
                                                         size = trips)) +
            coord_map(xlim = c(-74.03, -73.95), ylim = c(40.68, 40.79)) +
            scale_color_gradient2(low = "yellow", high = "black", midpoint = 300) +
            ggtitle(paste0("Total Citibike Trips Started at each Dock During Hours ", x, ":00 through ", y, ":00"))
      return(hour_usage_map)
}

maps_percent = function(x, y){
      library(ggplot2) 
      library(dplyr)
      library(maps)
      library(mapdata)
      library(rgdal)
      
      stat_lat_long = weekday_df[,c(1,2,3)]
      stat_lat_long = unique(stat_lat_long)
      
      nyc = get_map(location = "New York City", maptype = "roadmap", zoom = 12)
      nycMap = ggmap(nyc)
      nobs = filter(weekday_df, hour >= x & hour <= y)
      nobs = nrow(nobs)
      weekday_df_x_y = filter(weekday_df, hour >= x & hour <= y) %>%
            group_by(start.station.name) %>%
            summarise(trips = 100*(n()/nobs)) %>%
            inner_join(stat_lat_long, by = "start.station.name")
      max_station = arrange(weekday_df_x_y, desc(trips))
      print(max_station[1:5,])
      print(median(max_station$trips))
      hour_usage_map = nycMap + geom_point(data = weekday_df_x_y, 
                                           mapping = aes(x =start.station.longitude, 
                                                         y = start.station.latitude,
                                                         color = trips,
                                                         size = trips)) +
            coord_map(xlim = c(-74.03, -73.95), ylim = c(40.68, 40.79)) +
            scale_color_gradient2(low = "yellow", high = "black", midpoint = .035) +
            ggtitle(paste0("% of Citibike Trips Started at each Dock During Hours ", x, ":00 through ", y, ":00"))
      return(hour_usage_map)
}
```




```{r User Patterns weekday/weekend}
g_weekday_hour = ggplot(weekday_df, mapping = aes(hour))
g_weekend_hour = ggplot(weekend_df, mapping = aes(hour))

g_weekday_hour + geom_bar() + 
      xlab("Hour of the Day") + 
      ylab("Number of Trips Started") +
      ggtitle("Number of Citibike Trips Started Each Hour (WEEKDAYS)")

g_weekend_hour + geom_bar() + 
      xlab("Hour of the Day") + 
      ylab("Number of Trips Started") +
      ggtitle("Number of Citibike Trips Started Each Hour (WEEKENDS)")
```

## 
```{r}
#General Usage
maps_total(0, 23)
```

```{r}
maps_total(6, 10)
```

```{r}
maps_total(11, 15)
```

```{r}
maps_total(16, 20)
```


