---
title: "Changing Trend in Active Ingredients for Pain Relievers"
author: "Anne Chen"
date: "July 18, 2016"
output:
  ioslides_presentation:
    widescreen: true
    smaller: true
    fontsize: 15pt
---

```{r setup, include=FALSE}
# Data Source: http://www.fda.gov/Drugs/InformationOnDrugs/ucm079750.htm
# File Url: http://www.fda.gov/downloads/Drugs/InformationOnDrugs/UCM054599.zip
# Date Downloaded: 07/13/16 (a new update may be released around 07/22/16)

# Load libraries
library(ggplot2)
library(dplyr)
library(cowplot)
library(tidyr)
library(RColorBrewer)
library(scales)

# Mannually convert .txt into .csv if needed for easier reading, 
# and read data into R
application = read.csv("/Users/annecool37/Dropbox/DataScience/Project1/drugsatfda/application.csv", header = TRUE, sep = ",")
reg_date = read.table("/Users/annecool37/Dropbox/DataScience/Project1/drugsatfda/RegActionDate.txt", header = TRUE, sep = "\t")
product = read.csv("/Users/annecool37/Dropbox/DataScience/Project1/drugsatfda/Product.csv", header = TRUE, sep = ",")

# get ApplNo and Date for approval doc
id_date = filter(reg_date, DocType == "N") %>% transmute(ApplNo = ApplNo, date=as.integer(substr(as.character(ActionDate),1,4)))
application_partial = select(application, -ApplType, -MostRecentLabelAvailableFlag,
                             -CurrentPatentFlag, -ActionType)
product_partial = distinct(select(product, -ProductNo, -Form, -Dosage, 
                                  -ProductMktStatus ,-TECode, -ReferenceDrug, -drugname))
master_file = inner_join (inner_join(id_date, application_partial) , product_partial)

#####################
# Active Ingredient #
#####################
# dataset for studying active ingredient
# add a column that group by every 10 year
active_ingr = inner_join(inner_join(id_date, select(application, ApplNo, SponsorApplicant)),distinct(select(product, ApplNo, activeingred))) %>%
  mutate(activeingred = as.character(activeingred), 
         year_10 = floor(date/10)*10) %>% 
  rename(year = date)

# trend of total approval
approval_case_ai = summarise(group_by(active_ingr, year), approved_cases = n())
total_approval = ggplot(approval_case_ai, aes(x=year, y=approved_cases)) + 
  geom_point(size = 5, alpha = .5) + geom_smooth(color ="black") +
  labs (y="number of approved cases", 
        title = "Number of Approved New Drug Applications vs. Year") + 
  theme_bw() + scale_fill_brewer(palette = "BrBG")
total_approval

# get a general idea of which ingredient is often used w/o grouping by year
# get string of all active ingredients
df_active = data.frame(activeingred = unlist(strsplit(active_ingr$activeingred, split="; ")))
# find the active ingredient with highest frequency
sort_active = arrange(summarise(group_by(df_active, activeingred), count=n()), desc(count))
# list top 1o active ingredients and their application
# n is the number of active ingredient w/ top freqencies
n = 10
top_10_actives = sort_active$activeingred[1:n]
application_vec = data.frame( 
  "Application" = c("Pain Reliever", "Treat High Blood Pressure", 
                    "Oral Contraceptive", "Water and Electrolytes", 
                    "Nonsteroidal Anti-inflammatory Drug (NSAID)", 
                    "Water and Electrolytes", "Pain Reliever", 
                    "Increase Blood Sugar", "Treat Type 2 Diabetes", 
                    "Pain Reliever", "Other"))

# count and percentage
actives_count = transmute(sort_active, activeingred = as.character(activeingred), count = count)[1:n,]
remain_count = nrow(sort_active) - 
  summarise(actives_count, sum(count))[[1]]
sort_active_for_pie = rbind(actives_count, c("OTHER", remain_count)) %>%
  transmute(activeingred = activeingred, count = as.integer(count)) %>% 
  mutate(percentage = round(count*100/sum(count))) %>% cbind(application_vec)

# pie chart for top ingredients
pie_label = paste(as.character(sort_active_for_pie$activeingred), as.character(sort_active_for_pie$Application), sep = ": ")

sorted_actives_pie = ggplot(sort_active_for_pie, 
                            aes(x="", y=count, fill = activeingred)) + 
  geom_bar(width = 1, stat ="identity", alpha =.8) + 
  coord_polar("y", start = 0) + 
  theme_void() + theme(axis.text.x = element_blank()) +
  scale_fill_brewer(palette = "BrBG", 
                    name="ACTIVE INGREDIENT: Application", 
                    breaks = sort_active_for_pie$activeingred, 
                    labels = pie_label)

# generate df for the top n active ingredients
master_ai = arrange(distinct(select(active_ingr, year)), year) %>% 
  mutate(year = as.factor(year))
for (i in 1:n) {
  df = data.frame(table(active_ingr[grep(sort_active$activeingred[i],
                                         active_ingr$activeingr),
                                    "year"])) %>% rename("year"=Var1)
  master_ai = left_join(master_ai, df, by = "year")
}
master_ai[is.na(master_ai)] = 0
names(master_ai) = c("year",as.character(sort_active$activeingred)[1:n])
# transformation for plotting purpose
ai_to_plot = gather(master_ai, "year", "drug", 2:(n+1)) 
names(ai_to_plot) = c("year","active_ingr", "count")
ai_to_plot = transmute(ai_to_plot, year = as.integer(year), active_ingr=active_ingr, count=count)

# plot: year vs. count of different active ingredients
# normalize data
ai_to_plot = inner_join(ai_to_plot, approval_case_ai) %>% 
  mutate(norm_count = count/approved_cases)
ai_label = select(sort_active_for_pie, activeingred, 
                  Application)[1:10,] %>%
  arrange(activeingred) %>% 
  mutate( "label" = paste(as.character(activeingred), 
                          as.character(Application), sep = ": ")) 

# create general plotting function for active ingredient
plot_active_fun = function(data, y_value, ...) {
  ggplot(data, aes(x=strptime(year, format = "%Y"), y = y_value,
                   colour = active_ingr, group = active_ingr)) + 
    geom_smooth(se = FALSE, size = 3) + theme_bw()
}

# total counts for each active ingredient
g_ai = plot_active_fun(ai_to_plot, ai_to_plot$count) + 
  labs(y = "Number of Approved Cases", x = "Year") +
  scale_colour_brewer(palette = "BrBG") 

# normalized counts for each active ingredient
norm_g_ai = plot_active_fun(ai_to_plot, ai_to_plot$norm_count) + 
  labs(y = "Percentage of Approved Cases", x = "Year") +
  scale_colour_brewer(palette = "BrBG", 
                      name="ACTIVE INGREDIENT: Application", 
                      labels = ai_label$label) + 
  scale_y_continuous(labels=percent)

# combine two plots
p_frame = plot_grid(g_ai + theme(legend.position="none"), 
                    norm_g_ai + theme(legend.position="none"), 
                    align = 'vh', hjust = -1, nrow = 1, 
                    labels = c("Standard", "Normalized"))
grobs = ggplotGrob(norm_g_ai)$grobs
legend = grobs[[which(sapply(grobs, function(x) x$name) == "guide-box")]]
title = ggdraw() + 
  draw_label("Approved Cases for Top 10 Active Ingredients vs. Year")
p_with_legend = plot_grid(p_frame, legend, rel_widths = c(2,1))
final_ai_plot = plot_grid(title, p_with_legend, ncol=1, 
                          rel_heights=c(0.1, 1))

# subset pain reliever after year 1960 for plotting
pain_names = c("ACETAMINOPHEN", "HYDROCODONE BITARTRATE", 
               "IBUPROFEN", "OXYCODONE HYDROCHLORIDE")
pain_label = filter(ai_label, activeingred %in% pain_names)
# filter data after 1960
pain_to_plot = filter(ai_to_plot, active_ingr %in% 
                        pain_names, year >=1960) %>%
  arrange(active_ingr)

# functino to plot bar plot
bar_active_fun = function(data, y_value, grouping, label_vec){
  ggplot(data, aes(x=strptime(year, format = "%Y"), y=y_value, 
                   fill = grouping, group = grouping)) + 
    geom_bar(stat="identity") + theme_bw() +
    geom_smooth(color = "black") + 
    scale_fill_brewer(palette = "BrBG", name="Active Ingredient", 
                      labels = label_vec)
}

# pain reliver bar plot, raw count w/o normalization
pain_bar = bar_active_fun(pain_to_plot, pain_to_plot$count, pain_to_plot$active_ingr, pain_label) +
  labs(title = "Pain Reliever - Number of Approved Cases vs. Year", 
       y = "Number of Approved Cases", x = "Year") + 
  facet_grid(.~active_ingr)

# pain reliver bar plot, normalized w/ total approval cases
pain_bar_norm = bar_active_fun(pain_to_plot, pain_to_plot$norm_count, pain_to_plot$active_ingr, pain_label) +
  scale_y_continuous(labels = percent, limits = c(0, NA)) +
  labs(title = "Pain Reliever - Percentage of Approved Cases vs. Year", 
       y = "Percentage of Approved Cases", x = "Year") +
  facet_grid(.~active_ingr)
```


## Dataset Introduction
- Source: [Drugs at FDA database](http://www.fda.gov/Drugs/InformationOnDrugs/ucm079750.htm)
- Entity Relationship Diagram:  
<div style="text-align: center"><img src="/Users/annecool37/Dropbox/DataScience/Project1/FDADrugTablesMap.png" height="450px" width="650px" /></div>


## Number of Approved New Drug Applications Has Increase Over Past Decades 
```{r total_approval, fig.align="center", fig.width = 6, fig.height= 4, echo=FALSE}
total_approval
```

## Top 10 Active Ingredients in Approved Cases
```{r active_pie, fig.align="center", fig.width = 10, echo=FALSE}
sorted_actives_pie
```

## How Top 10 Active Ingredients Changes Over Years
```{r active_ingr_year, fig.width = 10, fig.align="center", echo=FALSE}
final_ai_plot
```

## Changing Trend in Active Ingredients for Pain Reliever
```{r pain_reliever_trend, fig.width = 10, fig.align="center", echo=FALSE, warning=FALSE}
pain_bar_norm
```
